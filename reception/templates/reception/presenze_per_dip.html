{% extends 'base/main.html' %}
{% load static %}
{% block content %}

<title>{% block title%}Lista Dipendenti Presenze{% endblock %}</title>
<link rel="stylesheet" href="{% static 'gestione/css/style.css' %}">
<script src="{% static 'gestione/js/script.js' %}"></script>
<script src="{% static 'reception/js/script.js' %}"></script>
<!-- Datatables -->

<link href="https://cdn.datatables.net/1.13.2/css/jquery.dataTables.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdn.datatables.net/1.13.2/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/v/bs5/jszip-2.5.0/dt-1.13.2/af-2.5.2/b-2.3.4/b-colvis-2.3.4/b-html5-2.3.4/b-print-2.3.4/cr-1.6.1/date-1.3.0/fc-4.2.1/fh-3.3.1/kt-2.8.1/r-2.4.0/rg-1.3.0/rr-1.3.2/sc-2.1.0/sb-1.4.0/sp-2.1.1/sr-1.2.1/datatables.min.js"></script>
    
    

<section id="styler-navbar" style="box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); margin-left:210px;">
    <header class="p-3 bg-light text-black">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
    
        <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
            <li class="nav-link px-2 text-dark"></li>            
            <li class="nav-link px-2 text-dark">Buon lavoro, {{user.first_name}}</li> 
        </ul>
        <div class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3">
            <input type="date" name="start" id="start" class="form-control form-control-dark" placeholder="Start..." aria-label="Start" value="{{start|date:'Y-m-d'}}">
        </div>
        <div class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3">
            <input type="date" name="end" id="end" class="form-control form-control-dark" placeholder="End..." aria-label="End" value="{{end|date:'Y-m-d'}}">
        </div>
        <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" id="reception-form-per-dipendente" method="POST" action="{% url 'reception:presenze_per_dip' %}">
            {% csrf_token %}
            <select class="form-control form-control-dark" aria-label="Default select example" name="dipendente">
                {% for dip in dipendenti %}
                <option id="dipendente" name="dipendente" value="{{dip.0}}" selected>{{dip.1|title}} {{dip.2|title}}</option>
                {% endfor %}
        </select>    
        </form>
        <div class="text-end">
            <button type="button" id="reception-form-per-dipendente-button" class="btn btn-success" onclick="submitFormPerDipendente()">Cerca</button>
            <button type="button" id="reception-scarica-dipendente-button" class="btn btn-warning" onclick="submitScaricaExcelPerDipendente()">Scarica</button>
            </div>
</header>
</section>

<section style="margin-left:220px; margin-top:25px;">
    <div class="cartaBox-table-reception-datatables-big">
        <div class="carta-table-reception-datatables-big">
            <div>
                <div class="numbers"></div>
                <div class="no-hover">
                <table class="table table-striped table-hover caption-top" id="table-presenze">
                        <caption>Lista Presenze <strong>{{dipper}}</strong> {% if start and end %} Periodo: {{start|date:'Y-m-d'}} - {{end|date:'Y-m-d'}}{% endif %}</caption>
                        <thead>
                            <tr>
                                <th> Dipendente </th>
                                <th> Giorno </th>
                                <th> Stato </th>
                                <th> Sede </th>
                                <th> Area </th>
                                <th> Tipo Contratto </th>
                                <th> Entrata </th>
                                <th> Uscita </th>
                                <th> Anticipo/Ritardo </th>
                                <th> Possibili Straordinari </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dipendente in queryset %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span>{{dipendente.nominativo}}</span>
                                        <span>  
                                        <div class="dropdown">
                                            <a href="#" class="d-flex align-items-center link-dark text-decoration-none dropdown-toggle" id="dropdownUser2" data-bs-toggle="dropdown" aria-expanded="false">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-mouse-fill" viewBox="0 0 16 16">
                                                    <path d="M3 5a5 5 0 0 1 10 0v6a5 5 0 0 1-10 0V5zm5.5-1.5a.5.5 0 0 0-1 0v2a.5.5 0 0 0 1 0v-2z"/>
                                                </svg>
                                            </a>
                                            <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
                                                <li><a class="dropdown-item" onclick="open_modal_modifica_ingresso('{% url 'reception:crea-ingresso' dipendente.id_ingresso %}')">Modifica in Modal</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="{% url 'reception:crea-ingresso2' dipendente.id_ingresso %}" target="_blank">Apri in nuova pagina</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </span>
                                </td>
                                <td>{{dipendente.giorno|date:'d-m-Y'}}</td>
                                <td><div {% if dipendente.tipo == 'Assente'%} class="stato assente text-center" style="color:white;" {% elif dipendente.entrata %} class="stato attivo text-center" style="color:white;" {% elif dipendente.tipo_permesso.id_permesso == 6 %} class="stato ferie text-center" style="color:white;" {% elif dipendente.in_permesso and dipendente.tipo_permesso == None  %} class="stato permesso text-center" style="color:white;"  {% elif dipendente.tipo_permesso != 6 and not dipendente.tipo_permesso == None  %} class="stato permesso text-center" style="color:white;" {% endif %}>{% if dipendente.tipo %} {{dipendente.tipo}} {% elif dipendente.entrata %} <i class="bi bi-check2"></i> {% elif dipendente.tipo_permesso.id_permesso == 6 %} F {% elif dipendente.in_permesso and dipendente.tipo_permesso == None  %} P {% elif dipendente.tipo_permesso != 6 and not dipendente.tipo_permesso == None  %} P {% endif %}</div></td>
                                <td>{{dipendente.id_dip_ing.sede.nome_sede|title}}</td>
                                <td>{{dipendente.id_dip_ing.area.nome_area|title}}</td>
                                <td><div {% if not dipendente.id_dip_ing.tipo_contratto.id_contratto  %} class="stato assente text-center" style="color:white;"   {% elif dipendente.id_dip_ing.tipo_contratto.id_contratto == 5 %} class="stato piva text-center" style="color:white;" {% elif dipendente.id_dip_ing.tipo_contratto.id_contratto == 1 or dipendente.id_dip_ing.tipo_contratto.id_contratto == 2 or dipendente.id_dip_ing.tipo_contratto.id_contratto == 3 %} class="stato contrattostandard text-center" style="color:white;" {% elif dipendente.id_dip_ing.tipo_contratto.id_contratto == 4 %} class="stato occasionale text-center" style="color:white;" {% elif dipendente.id_dip_ing.tipo_contratto.id_contratto == 7 %} class="stato tirocinante text-center" style="color:white;" {% endif %}> {% if not dipendente.id_dip_ing.tipo_contratto.nome_contratto %} Mancante {% elif dipendente.id_dip_ing.tipo_contratto.nome_contratto  %} {{ dipendente.id_dip_ing.tipo_contratto.nome_contratto|title }} {% endif %}</div></td>
                                <td>{% if dipendente.entrata %} {{dipendente.entrata|time:"H:i"}} {% else %} -- {% endif %}</td>
                                <td>{% if dipendente.seconda_uscita != none %} {{dipendente.seconda_uscita}} {% elif dipendente.uscita %} {{dipendente.uscita|time:"H:i"}}  {% else %} -- {% endif %} </td>
                                <td>{% if dipendente.anticipo %} Ant: {{dipendente.anticipo}} {% elif dipendente.ritardo %} Rit: {{dipendente.ritardo}} {% else %} -- {% endif %}</td>
                                <td>{% if dipendente.straordinario %} {{dipendente.straordinario}} {% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th> Dipendente </th>
                                <th> Giorno </th>
                                <th> Stato </th>
                                <th> Sede </th>
                                <th> Area </th>
                                <th> Tipo Contratto </th>
                                <th> Entrata </th>
                                <th> Uscita </th>
                                <th> Anticipo/Ritardo </th>
                                <th> Possibili Straordinari </th>
                            </tr>
                        </tfoot>
                    </table>
            </div>
            </div>
            <div class="iconBox">
                <svg xmlns="http://www.w3.org/2000/svg" width="55" height="55" fill="currentColor" class="bi bi-calendar4-range" viewBox="0 0 16 16">
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z"/>
                    <path d="M9 7.5a.5.5 0 0 1 .5-.5H15v2H9.5a.5.5 0 0 1-.5-.5v-1zm-2 3v1a.5.5 0 0 1-.5.5H1v-2h5.5a.5.5 0 0 1 .5.5z"/>
                    </svg>
            </div>
        </div>
    </div>    
</section>

<div class="modal fade" id="modificaIngresso" role="dialog" tabindex="-1">
</div>

<script>

var $ = jQuery.noConflict();
function open_modal_modifica_ingresso(url){
    $('#modificaIngresso').load(url,function(){
    $(this).modal('show'); 
    });
};

$(document).ready(function () {
    // Setup - add a text input to each footer cell
    $('#table-presenze thead tr')
        .clone(true)
        .addClass('filters')
        .appendTo('#table-presenze thead');
    
    var table = $('#table-presenze').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                className: 'btn btn-secondary',
                text: 'Copia'
            },
            {
                extend: 'excel',
                className: 'btn btn-success',
                text: 'Excel'
            },
            {
                extend: 'pdfHtml5',
                className: 'btn btn-danger',
                text: 'PDF',
                orientation: 'landscape',
                pageSize: 'A3',
                exportOptions: {
                columns: ':visible'
                },
                customize: function(doc) {
                    doc.content.forEach(function(item) {
                    if (item.text) {
                    item.text[0].fontSize = 8 // Set the font size to 8pt
                    }
                });
                }
            },
        ],
        initComplete: function () {
            var api = this.api();
    
            // For each column
            api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                    // Set the header cell to contain the input element
                    var cell = $('.filters th').eq(
                        $(api.column(colIdx).header()).index()
                    );
                    var title = $(cell).text();
                    $(cell).html('<input type="text" placeholder="' + title + '" />');
    
                    // On every keypress in this input
                    $(
                        'input',
                        $('.filters th').eq($(api.column(colIdx).header()).index())
                    )
                        .off('keyup change')
                        .on('change', function (e) {
                            // Get the search value
                            $(this).attr('title', $(this).val());
                            var regexr = '({search})'; //$(this).parents('th').find('select').val();
    
                            var cursorPosition = this.selectionStart;
                            // Search the column for that value
                            api
                                .column(colIdx)
                                .search(
                                    this.value != ''
                                        ? regexr.replace('{search}', '(((' + this.value + ')))')
                                        : '',
                                    this.value != '',
                                    this.value == ''
                                )
                                .draw();
                        })
                        .on('keyup', function (e) {
                            e.stopPropagation();
    
                            $(this).trigger('change');
                            $(this)
                                .focus()[0]
                                .setSelectionRange(cursorPosition, cursorPosition);
                        });
                });
        },
    });
});

</script>

{% endblock content %}

